{% extends "base.html" %}
{% block content %}
{% with active_page='live' %}
    {% include 'toggle_live_switch.html' %}
{% endwith %}

<div class="max-w-3xl mx-auto px-4 py-4">
    <!-- Race Info -->
    <div class="text-center mb-4">
        <h1 id="race_name" class="text-xl md:text-2xl font-bold text-gray-900"></h1>
        <p id="race_info" class="text-sm md:text-base text-gray-600 mt-1"></p>
    </div>

    <!-- Current Driver Card -->
    <div id="currentDriver" class="bg-white rounded-lg shadow-sm mb-4" style="display: none;">
        <!-- Content inserted by JS -->
    </div>

    <!-- Upcoming Drivers -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden mb-4">
        <div class="px-3 py-2 bg-gray-50">
            <h2 class="text-base font-medium text-gray-900 text-center">Kommende startende</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <tbody id="upcoming_entries" class="divide-y divide-gray-200">
                    <!-- Content inserted by JS -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Finished Drivers -->
    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
        <div class="px-3 py-2 bg-gray-50">
            <h2 class="text-base font-medium text-gray-900 text-center">Resultat</h2>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full">
                <tbody id="finished_entries" class="divide-y divide-gray-200">
                    <!-- Content inserted by JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io('/live_data');

    socket.on('connect', () => {
        console.log('Connected to server');
        const deviceId = 'device_' + Math.random().toString(36).substr(2, 9);
        socket.emit('device_connected', { deviceId: deviceId });
    });

    socket.on('server_response', handleSocketData);
    socket.on('message', handleSocketData);

    function handleSocketData(data) {
        let parsedData;
        try {
            parsedData = typeof data === 'object' ? data : JSON.parse(data);
            if (parsedData.data && typeof parsedData.data === 'string') {
                parsedData = JSON.parse(parsedData.data);
            }
        } catch (error) {
            console.error('Error parsing data:', error);
            return;
        }
        
        console.log('Received data:', parsedData);


        if (
            parsedData &&
            parsedData.driver_data &&
            parsedData.driver_data[0] &&
            parsedData.driver_data[0].mode &&
            !parsedData.driver_data[0].mode.toLowerCase().includes("finale")
        ) {
            location.reload();
        } else {
            console.log('Data is for finale');
        }
        updateRaceData(parsedData);
    }

    function convertMilliseconds(ms) {
        const seconds = (ms / 1000).toFixed(3);
        const minutes = Math.floor(seconds / 60);
        
        if (minutes > 0) {
            const remainingSeconds = (seconds % 60).toFixed(3);
            return `${minutes}:${remainingSeconds.padStart(6, '0')}`;
        } else {
            return seconds;
        }
    }

    function getTimeDisplay(driver) {
        if (driver.penalty === 1) return { time: 'DNS', color: 'text-red-600' };
        if (driver.penalty === 2) return { time: 'DNF', color: 'text-red-600' };
        if (driver.penalty === 3) return { time: 'DSQ', color: 'text-red-600' };
        return { 
            time: convertMilliseconds(driver.finishtime),
            color: driver.finishtime > 0 ? 'text-green-600' : 'text-gray-900'
        };
    }

    function updateRaceData(raceData) {
        if (!raceData?.driver_data?.length || !raceData.state) return;

        const { driver_data, state, kvali_data, kvali_crit } = raceData;
        const activeDriver = driver_data.find(driver => driver.cid === state.active_driver_1);

        // Update race info
        document.getElementById('race_name').textContent = state.active_race;
        document.getElementById('race_info').textContent = 
            `Heat ${state.active_heat} • ${driver_data.length} Førere`;

        // Split and sort drivers - moved to top of function
        const upcomingDrivers = driver_data
            .filter(driver => driver.finishtime === 0 && driver.penalty === 0);

        const finishedDrivers = driver_data
            .filter(driver => driver.finishtime > 0 || driver.penalty !== 0)
            .sort((a, b) => {
                // Drivers with penalties go to the bottom
                if (a.penalty !== 0 && b.penalty === 0) return 1;
                if (a.penalty === 0 && b.penalty !== 0) return -1;
                if (a.penalty !== 0 && b.penalty !== 0) return 0;
                // Sort by finish time for non-penalty drivers
                return a.finishtime - b.finishtime;
            });

        // Update current driver - now with conditional rendering and more compact design
        const currentDriverElement = document.getElementById('currentDriver');
        if (activeDriver) {
            const timeInfo = getTimeDisplay(activeDriver);
            const position = upcomingDrivers.indexOf(activeDriver) + 1;
            
            currentDriverElement.style.display = 'block';
            currentDriverElement.innerHTML = `
                <div class="flex items-center justify-between px-3 py-2">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center justify-between">
                            <div class="truncate">
                                <div class="text-xs text-gray-500">
                                    Fører ${position}/${upcomingDrivers.length}
                                </div>
                                <h3 class="text-lg font-semibold text-gray-900 truncate">
                                    ${activeDriver.driver_name}
                                </h3>
                                <p class="text-sm text-gray-600 truncate">
                                    ${activeDriver.vehicle}
                                </p>
                            </div>
                            <div class="ml-4 flex-shrink-0">
                                <span class="text-xl font-bold ${timeInfo.color}">
                                    ${timeInfo.time}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        } else {
            currentDriverElement.style.display = 'none';
        }

        // Update upcoming drivers table
        document.getElementById('upcoming_entries').innerHTML = upcomingDrivers
            .map((driver, index) => {
                const isActive = driver.cid === state.active_driver_1;
                return `
                    <tr class="${isActive ? 'bg-blue-50' : 'bg-white'}">
                        <td class="px-3 py-2 text-sm text-gray-500 w-10">
                            ${index + 1}
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm font-medium text-gray-900 truncate">
                                ${driver.driver_name}
                            </div>
                            <div class="text-sm text-gray-500 truncate md:hidden">
                                ${driver.vehicle}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-500 hidden md:table-cell truncate">
                            ${driver.vehicle}
                        </td>
                    </tr>
                `;
            })
            .join('');

        // Update finished drivers table
        document.getElementById('finished_entries').innerHTML = finishedDrivers
            .map((driver, index) => {
                const timeInfo = getTimeDisplay(driver);
                return `
                    <tr class="bg-white">
                        <td class="px-3 py-2 text-sm text-gray-500 w-10">
                            ${index + 1}
                        </td>
                        <td class="px-3 py-2">
                            <div class="text-sm font-medium text-gray-900 truncate">
                                ${driver.driver_name}
                            </div>
                            <div class="text-sm text-gray-500 truncate md:hidden">
                                ${driver.vehicle}
                            </div>
                        </td>
                        <td class="px-3 py-2 text-sm text-gray-500 hidden md:table-cell truncate">
                            ${driver.vehicle}
                        </td>
                        <td class="px-3 py-2 text-sm font-medium ${timeInfo.color} text-right">
                            ${timeInfo.time}
                        </td>
                    </tr>
                `;
            })
            .join('');


    }

</script>
{% endblock %}